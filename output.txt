----
configuration.nix

{ config, pkgs, ... }:

{
  imports = [

    ##########################################
    # Host profile
    # Choose ONLY ONE
    ##########################################

    # Dell Inspiron 1564 (Legacy BIOS)
    ./profiles/dell.nix

    # MacBook Pro 13" 2011 (EFI)
    # Uncomment this when deploying on the MacBook
    # ./profiles/macbook.nix


    ##########################################
    # Shared system modules (host-agnostic)
    ##########################################
    ./modules/kernel-tuning.nix
    ./modules/fonts.nix
    ./modules/system-packages.nix

    ./modules/desktop-gnome.nix

    ./modules/containers/docker.nix
    ./modules/containers/k3s.nix

    ./modules/maintenance.nix
    ./modules/maintenance-hm.nix

    ./modules/user-borba.nix
    ./modules/nix-unstable.nix
  ];

  ############################################
  # Hostname / Networking
  ############################################
  networking.hostName = "nixos";

  ############################################
  # Locale / Time
  ############################################
  time.timeZone = "America/Sao_Paulo";
  i18n.defaultLocale = "en_US.UTF-8";
  i18n.extraLocaleSettings = {
    LC_ADDRESS = "pt_BR.UTF-8";
    LC_IDENTIFICATION = "pt_BR.UTF-8";
    LC_MEASUREMENT = "pt_BR.UTF-8";
    LC_MONETARY = "pt_BR.UTF-8";
    LC_NAME = "pt_BR.UTF-8";
    LC_NUMERIC = "pt_BR.UTF-8";
    LC_PAPER = "pt_BR.UTF-8";
    LC_TELEPHONE = "pt_BR.UTF-8";
    LC_TIME = "pt_BR.UTF-8";
  };

  ############################################
  # System state version
  ############################################
  system.stateVersion = "25.11";
}

----
hardware-configuration-dell.nix

# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "ehci_pci" "ahci" "ums_realtek" "usb_storage" "sd_mod" "sr_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/1acae91f-ffb3-40e6-8e0d-dd2b63c6c4bb";
      fsType = "ext4";
    };

  swapDevices = [ ];

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}

----
hardware-configuration-macbook.nix

# Do not modify this file!  It was generated by ‘nixos-generate-config’
# and may be overwritten by future invocations.  Please make changes
# to /etc/nixos/configuration.nix instead.
{ config, lib, pkgs, modulesPath, ... }:

{
  imports =
    [ (modulesPath + "/installer/scan/not-detected.nix")
    ];

  boot.initrd.availableKernelModules = [ "ehci_pci" "ahci" "ums_realtek" "usb_storage" "sd_mod" "sr_mod" ];
  boot.initrd.kernelModules = [ ];
  boot.kernelModules = [ "kvm-intel" ];
  boot.extraModulePackages = [ ];

  fileSystems."/" =
    { device = "/dev/disk/by-uuid/1acae91f-ffb3-40e6-8e0d-dd2b63c6c4bb";
      fsType = "ext4";
    };

  swapDevices = [ ];

  nixpkgs.hostPlatform = lib.mkDefault "x86_64-linux";
  hardware.cpu.intel.updateMicrocode = lib.mkDefault config.hardware.enableRedistributableFirmware;
}

----
hosts/dell-inspiron/configuration.nix

# hosts/dell-inspiron/configuration.nix
{ ... }:

{
  imports = [
    ../../hardware-configuration-dell.nix

    ../../modules/nixpkgs.nix
    ../../modules/base.nix
    ../../modules/networking.nix
    ../../modules/audio.nix
    ../../modules/fonts.nix
    ../../modules/kernel-tuning.nix
    ../../modules/maintenance.nix

    ../../modules/users/borba.nix
    ../../modules/system-packages.nix

    ../../modules/desktops/gnome.nix
    ../../modules/containers/docker.nix
    ../../modules/virtualization/libvirt.nix
    ../../modules/hardware/dell.nix
  ];

  networking.hostName = "dell-nixos";
  system.stateVersion = "25.11";
}

----
hosts/macbook-2011/configuration.nix

# hosts/macbook-2011/configuration.nix
{ ... }:

{
  imports = [
    ../../hardware-configuration-macbook.nix

    ../../modules/nixpkgs.nix
    ../../modules/base.nix
    ../../modules/networking.nix
    ../../modules/audio.nix
    ../../modules/fonts.nix
    ../../modules/kernel-tuning.nix
    ../../modules/maintenance.nix

    ../../modules/users/borba.nix
    ../../modules/system-packages.nix

    ../../modules/desktops/gnome.nix
    ../../modules/hardware/macbook.nix
    ../../modules/hardware/macbook-efi.nix
  ];

  networking.hostName = "macbook-nixos";
  system.stateVersion = "25.11";
}

----
modules/audio.nix

{ ... }:
{
  services.pulseaudio.enable = false;
  security.rtkit.enable = true;

  services.pipewire = {
    enable = true;
    alsa.enable = true;
    alsa.support32Bit = true;
    pulse.enable = true;
  };
}

----
modules/base.nix

{ pkgs, ... }:
{
  nix.extraOptions = ''
    experimental-features = nix-command flakes
  '';

  time.timeZone = "America/Sao_Paulo";

  i18n.defaultLocale = "en_US.UTF-8";
  i18n.extraLocaleSettings = {
    LC_ADDRESS = "pt_BR.UTF-8";
    LC_IDENTIFICATION = "pt_BR.UTF-8";
    LC_MEASUREMENT = "pt_BR.UTF-8";
    LC_MONETARY = "pt_BR.UTF-8";
    LC_NAME = "pt_BR.UTF-8";
    LC_NUMERIC = "pt_BR.UTF-8";
    LC_PAPER = "pt_BR.UTF-8";
    LC_TELEPHONE = "pt_BR.UTF-8";
    LC_TIME = "pt_BR.UTF-8";
  };

  console.keyMap = "br-abnt2";
}

----
modules/containers/docker.nix

{ lib, ... }:
{
  virtualisation.docker = {
    enable = true;
    enableOnBoot = true;
  };
}

----
modules/containers/k3s.nix

{ config, pkgs, ... }:

{
  ############################################
  # K3s (single-node workstation cluster)
  ############################################
  services.k3s = {
    enable = true;
    role = "server";

    extraFlags = [
      "--write-kubeconfig-mode=644"
      "--disable=traefik"
      "--disable=servicelb"
    ];
  };

  ############################################
  # Firewall
  ############################################
  networking.firewall.allowedTCPPorts = [
    6443 # Kubernetes API
  ];
}

----
modules/containers/podman.nix

{ config, pkgs, ... }:

{
  ############################################
  # Podman (rootless, Docker-compatible)
  ############################################
  virtualisation.podman = {
    enable = true;

    # Enable Docker-compatible CLI and socket
    # Allows using Docker tools against Podman
    dockerCompat = true;

    # Enable default Podman bridge with DNS
    defaultNetwork.settings = {
      dns_enabled = true;
    };
  };

  ############################################
  # Rootless Podman requirements
  ############################################

  # Allow user services to run without active login
  users.users.borba.linger = true;

  ############################################
  # Firewall (Podman default bridge)
  ############################################
  networking.firewall.trustedInterfaces = [
    "podman0"
  ];
}

----
modules/desktops/base.nix

{ config, pkgs, ... }:

{
  ############################################
  # Base for all Desktop Environments
  ############################################
  services.xserver.enable = true;
  security.polkit.enable = true;

  # X11 Keyboard layout
  services.xserver.xkb = {
    layout = "br";
    variant = "";
  };
  console.keyMap = "br-abnt2";

  # Auto-login handled by user-borba.nix

  # Wayland / XDG Portals
  xdg.portal.enable = true;
  environment.sessionVariables = {
    XDG_SESSION_TYPE = "wayland";
    QT_QPA_PLATFORM = "wayland";
    QT_WAYLAND_DISABLE_WINDOWDECORATION = "1";
    MOZ_ENABLE_WAYLAND = "1";
    NIXOS_OZONE_WL = "1";
  };
}

----
modules/desktops/gnome.nix

{ pkgs, ... }:
{
  services.xserver.enable = true;

  services.displayManager.gdm = {
    enable = true;
    wayland = true;
  };

  services.desktopManager.gnome.enable = true;

  services.displayManager.autoLogin = {
    enable = true;
    user = "borba";
  };

  systemd.services."getty@tty1".enable = false;
  systemd.services."autovt@tty1".enable = false;

  xdg.portal = {
    enable = true;
    extraPortals = with pkgs; [
      xdg-desktop-portal-gnome
      xdg-desktop-portal-gtk
    ];
  };
}


----
modules/fonts.nix

{ pkgs, ... }:

{
  ############################################
  # Fonts
  ############################################
  fonts = {
    packages = with pkgs; [
      nerd-fonts.jetbrains-mono
    ];

    fontconfig = {
      enable = true;

      defaultFonts = {
        monospace = [ "JetBrainsMono Nerd Font" ];
      };
    };
  };
}

----
modules/hardware/dell.nix

{ pkgs, ... }:
{
  hardware.enableRedistributableFirmware = true;

  networking.enableB43Firmware = true;

  boot.blacklistedKernelModules = [ "brcmsmac" "wl" ];

  environment.systemPackages = with pkgs; [
    b43-firmware-legacy
    b43-fwcutter
    wirelesstools
    rfkill
  ];

  boot.loader.grub = {
    enable = true;
    devices = [ "/dev/sda" ];
  };
}

----
modules/hardware/macbook.nix

{ pkgs, ... }:
{
  hardware.enableRedistributableFirmware = true;

  networking.enableB43Firmware = true;

  boot.blacklistedKernelModules = [ "brcmsmac" "wl" ];

  environment.systemPackages = with pkgs; [
    b43-firmware-legacy
    b43-fwcutter
    wirelesstools
    rfkill
  ];

  boot.loader.grub = {
    enable = true;
    devices = [ "/dev/sda" ];
  };
}

----
modules/networking.nix

{ ... }:
{
  networking.networkmanager.enable = true;

  systemd.services.NetworkManager-wait-online.enable = false;
}

----
modules/nixpkgs.nix

{ ... }:
{
  nixpkgs.overlays = [
    (final: prev: {
      unstable = import <nixpkgs-unstable> {
        config.allowUnfree = true;
      };
    })
  ];
}

----
modules/system-packages.nix

{ pkgs, ... }:

{
  environment.systemPackages = with pkgs; [

    ##########################################
    # Terminals
    ##########################################
    alacritty
    kitty
    gnome-console

    ##########################################
    # Shells / Multiplexers
    ##########################################
    zsh
    fish
    tmux
    tmuxifier
    stow
    tree

    ##########################################
    # Editors / IDEs / Git
    ##########################################
    unstable.neovim
    unstable.vscode
    unstable.vscode-extensions.ms-vscode-remote.remote-containers
    lazygit
    git
    gh
    devcontainer

    ##########################################
    # Notes / Knowledge Base
    ##########################################
    unstable.obsidian

    ##########################################
    # Containers / Virtualization / Kubernetes
    ##########################################
    docker
    docker-compose
    docker-buildx
    lazydocker
    podman
    podman-compose
    buildah
    skopeo
    cri-tools
    k9s

    virt-manager
    virt-viewer
    qemu
    virtio-win
    spice
    spice-gtk
    spice-protocol

    ##########################################
    # Languages / Toolchains
    ##########################################
    gcc
    libgcc
    glibc
    libcxx
    go
    gopls
    rustup
    rust-analyzer

    ##########################################
    # Build / Development Tools
    ##########################################
    cmake
    gnumake
    libtool
    libvterm
    unstable.gdb
    unstable.clang
    unstable.llvm
    unstable.lld

    ##########################################
    # Nix Tooling
    ##########################################
    nixd
    nil
    statix
    deadnix
    nixfmt-rfc-style

    ##########################################
    # Modern CLI Utilities
    ##########################################
    eza
    btop
    bat
    htop
    fd
    ripgrep
    yazi
    xclip
    wl-clipboard
    clipster

    ##########################################
    # Core UNIX Utilities
    ##########################################
    coreutils
    curl
    wget
    gnupg
    file
    rsync
    unzip
    zip
    procps
    psmisc
    util-linux

    ##########################################
    # Hardware / System Debug
    ##########################################
    lshw
    pciutils
    usbutils
    lm_sensors

    ##########################################
    # Network / Connectivity
    ##########################################
    iwd
    iproute2
    iputils
    traceroute
    dnsutils
    nmap

    ##########################################
    # Storage / Filesystems
    ##########################################
    e2fsprogs
    ntfs3g
    dosfstools

    ##########################################
    # Certificates / SSL
    ##########################################
    cacert

    ##########################################
    # GUI Applications
    ##########################################
    firefox
    chromium
    brave
    unstable.discord
    flameshot
    chirp
    unstable.anydesk
  ];
}

----
modules/users/borba.nix

{ pkgs, ... }:
{
  users.users.borba = {
    isNormalUser = true;
    description = "BORBA JR W";
    shell = pkgs.zsh;

    extraGroups = [
      "wheel"
      "networkmanager"
      "docker"
      "libvirtd"
      "dialout"
    ];
  };

  security.sudo.extraRules = [
    {
      users = [ "borba" ];
      commands = [
        {
          command = "/run/current-system/sw/bin/nixos-rebuild";
          options = [ "NOPASSWD" ];
        }
      ];
    }
  ];
}

----
modules/virtualization/libvirt.nix

{ ... }:
{
  virtualisation.libvirtd = {
    enable = true;

    qemu.swtpm.enable = true;

    allowedBridges = [
      "virbr0"
      "br0"
    ];
  };

  security.polkit.enable = true;
}

----
output.txt



# Multiple Sessions in GDM - Change Log

## Problem
After the refactor, the GDM session selector no longer showed the GNOME and Niri options.

## Implemented Solution

### 1. Created a system-level module for Niri
**File**: `modules/desktops/niri/system.nix`
- Enables `programs.niri` at the system level
- Adds xwayland-satellite
- Configures XDG portals for Niri

### 2. Updated hosts/macbook.nix
Now it imports both desktops:
```nix
../modules/desktops/gnome.nix
../modules/desktops/niri/system.nix  # New line
```

### 3. Adjusted XDG Portal Configuration
Reorganized to avoid conflicts:
- `modules/xdg-portal.nix`: Basic configuration with mkDefault
- `modules/desktops/gnome.nix`: Adds GTK portal
- `modules/desktops/niri/system.nix`: Adds GNOME portal for compatibility

### 4. Updated documentation
- `modules/desktops/niri/README.md`: Documents configuration at two levels

## How to Test

1. Build the configuration:
```bash
make check
make test-build HOST=macbook
```

2. If it passes, apply:
```bash
make switch HOST=macbook
```

3. Restart and verify:
- On the GDM login screen, click the gear icon
- The options should appear: "GNOME", "Niri", "GNOME (X11)"

## Niri Structure Now

```
modules/desktops/niri/
├── system.nix          # System: enables session in GDM
├── default.nix         # Home-manager: user config
├── config.nix
├── input.nix
├── output.nix
├── layout.nix
├── keybindings.nix
├── window-rules.nix
├── animations.nix
├── waybar.nix
├── mako.nix
├── fuzzel.nix
└── README.md
```

## Modified Files

- ✅ `modules/desktops/niri/system.nix` (CREATED)
- ✅ `hosts/macbook.nix` (import added)
- ✅ `modules/xdg-portal.nix` (simplified)
- ✅ `modules/desktops/gnome.nix` (portal adjusted)
- ✅ `modules/desktops/niri/README.md` (documentation)

## If It Does Not Work

Check logs:
```bash
journalctl -xeu gdm.service
systemctl status gdm
ls -la /run/current-system/sw/share/wayland-sessions/
ls -la /run/current-system/sw/share/xsessions/
```

The session .desktop files should be in these directories.
